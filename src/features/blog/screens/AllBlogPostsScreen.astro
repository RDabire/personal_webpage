---
import {
  FilteredPostsList,
  type PostDataForFilter,
} from '@/features/blog/components/FilteredPostsList';
import { BlogPostCard } from '@/features/blog';
import type { LanguageCode } from '@/i18n/ui';
import { useTranslations } from '@/i18n/ui';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { type CollectionEntry as AstroCollectionEntry } from 'astro:content';
import { EmptyState } from '@/components/empty-state';

type Props = {
  posts: AstroCollectionEntry<'blog'>[];
  lang: LanguageCode;
};

const { posts, lang } = Astro.props;

const initialSearchQuery = Astro.url.searchParams.get('q') || '';
const initialTag = Astro.url.searchParams.get('tag') || '';

const texts = useTranslations(lang, 'blogPage');

const getSlugWithoutLocale = (id: string) => {
  const parts = id.split('/');
  return parts.length > 1 ? parts.slice(1).join('/') : parts[0];
};

function transformPostForClientFilter(
  post: AstroCollectionEntry<'blog'>
): PostDataForFilter {
  return {
    id: post.id,
    slug: getSlugWithoutLocale(post.id ?? ''),
    title: post.data.title,
    description: post.data.description || '',
    tags: post.data.tags,
    body: post.body ?? '',
    pubDate: post.data.pubDate,
  };
}

const componentTexts = {
  searchPlaceholder: texts('searchPlaceholder'),
  filterByTagButtonLabel: texts('filterByTagButtonLabel'),
  noTagFound: texts('noTagFound'),
  selectTagCommandPlaceholder: texts('selectTagCommandPlaceholder'),
  allTagsLabel: texts('allTagsLabel'),
  noPostsFound: texts('noPostsFound'),
};

const t = useTranslations(lang, 'blogPage');

const pageTitle = t('pageTitle');
const pageDescription = t('pageDescription');

const featuredTags = [
  ...new Set(
    posts
      .flatMap((post) => post.data.tags || [])
      .map((tag) => tag.trim())
      .filter(Boolean)
  ),
].slice(0, 6);
---

<BaseLayout {pageTitle} {pageDescription}>
  <section class="content-shell page-intro">
    <h1 class="headline-display max-w-3xl">{t('description')}</h1>
    <p class="lede">
      Practical ML notes from projects, experiments, and production lessons.
    </p>

    {
      featuredTags.length > 0 && (
        <div class="mt-6 flex flex-wrap gap-2">
          {featuredTags.map((tag) => (
            <a
              href={`/blog?tag=${encodeURIComponent(tag)}`}
              class:list={[
                'rounded-full border px-3 py-1 text-xs font-medium uppercase tracking-[0.12em] transition-colors',
                initialTag === tag
                  ? 'border-primary/80 bg-primary/15 text-primary'
                  : 'border-border bg-card/50 text-muted-foreground hover:border-primary/60 hover:text-foreground',
              ]}
            >
              {tag}
            </a>
          ))}
        </div>
      )
    }
  </section>

  <section class="content-shell reveal">
    <FilteredPostsList
      client:load
      allPosts={posts.map(transformPostForClientFilter)}
      texts={componentTexts}
      initialSearchQuery={initialSearchQuery}
      initialTag={initialTag}
    />

    <div
      id="blog-posts-container"
      class="mt-8 grid gap-6 md:grid-cols-2 xl:grid-cols-3"
    >
      {
        posts.length > 0 ? (
          posts.map((postEntry) => (
            <div class="blog-post-card-wrapper" data-post-id={postEntry.id}>
              <BlogPostCard post={postEntry} lang={lang} />
            </div>
          ))
        ) : (
          <EmptyState
            title={texts('noPostsFound')}
            id="no-posts-initial-message"
            className="hidden panel"
          />
        )
      }
    </div>

    <EmptyState
      title={texts('noPostsFound')}
      id="no-posts-filtered-message"
      className="hidden panel"
    />

    <script>
      import {
        filteredPostIdsAtom,
        filtersInitializedAtom,
      } from '../../../stores/blogFilterStore';

      const postsContainer = document.getElementById('blog-posts-container');
      const noPostsInitialMessage = document.getElementById(
        'no-posts-initial-message'
      );
      const noPostsFilteredMessage = document.getElementById(
        'no-posts-filtered-message'
      );
      const allPostCardWrappers = document.querySelectorAll(
        '.blog-post-card-wrapper'
      );

      function updateVisiblePosts() {
        if (!postsContainer || !noPostsFilteredMessage) return;

        const currentFilteredIds = filteredPostIdsAtom.get();
        const isFiltersInitialized = filtersInitializedAtom.get();
        let visibleCount = 0;

        allPostCardWrappers.forEach((wrapper) => {
          const postIdAttribute = wrapper.getAttribute('data-post-id');
          if (postIdAttribute !== null) {
            if (currentFilteredIds.includes(postIdAttribute)) {
              wrapper.classList.remove('hidden');
              visibleCount++;
            } else {
              wrapper.classList.add('hidden');
            }
          } else {
            wrapper.classList.add('hidden');
          }
        });

        if (noPostsInitialMessage) {
          noPostsInitialMessage.classList.add('hidden');
        }

        if (isFiltersInitialized) {
          if (visibleCount === 0) {
            postsContainer.style.display = 'none';
            noPostsFilteredMessage.classList.remove('hidden');
          } else {
            postsContainer.style.display = 'grid';
            noPostsFilteredMessage.classList.add('hidden');
          }
        }
      }

      filteredPostIdsAtom.subscribe(updateVisiblePosts);

      filtersInitializedAtom.subscribe((isInitialized: boolean) => {
        if (isInitialized) {
          updateVisiblePosts();
        }
      });

      if (filtersInitializedAtom.get()) {
        updateVisiblePosts();
      }
    </script>
  </section>
</BaseLayout>
